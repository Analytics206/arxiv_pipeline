<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open Models Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; }
    .controls { text-align: center; margin-bottom: 20px; }
    .model-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .model-card h2 { margin: 0 0 10px; }
    .meta { font-size: 0.9em; color: #555; }
    input, select { padding: 5px; margin: 0 5px; }
    a.model-link { text-decoration: none; color: #1a0dab; }
  </style>
</head>
<body>
  <h1>Open Models Viewer</h1>
  <div class="controls">
    <select id="sourceSelector">
      <option value="huggingface">Hugging Face</option>
      <option value="ollama">Ollama (Installed)</option>
      <option value="ollama-available">Ollama (Available)</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search by model ID...">
    <select id="pipelineFilter">
      <option value="">All Pipelines</option>
    </select>
    <button onclick="sortByScore()">Sort by Score</button>
  </div>
  <div id="models-container">Loading models...</div>

  <script>
    let models = [];
    let currentSortByScore = false;

    async function loadModels(source = 'huggingface') {
      try {
        let file;
        if (source === 'huggingface') file = 'open_models_data.json';
        else if (source === 'ollama') file = 'ollama_models_data.json';
        else if (source === 'ollama-available') file = 'ollama_available_models.json';

        const response = await fetch(file);
        const data = await response.json();
        models = data.models;
        populatePipelineFilter();
        renderModels();
      } catch (err) {
        document.getElementById('models-container').textContent = 'Failed to load models.';
        console.error(err);
      }
    }

    function populatePipelineFilter() {
      const uniquePipelines = [...new Set(models.map(m => m.pipeline_tag).filter(Boolean))];
      const filterSelect = document.getElementById('pipelineFilter');
      filterSelect.innerHTML = '<option value="">All Pipelines</option>';
      uniquePipelines.forEach(pipeline => {
        const opt = document.createElement('option');
        opt.value = pipeline;
        opt.textContent = pipeline;
        filterSelect.appendChild(opt);
      });
    }

    function sortByScore() {
      currentSortByScore = true;
      renderModels();
    }

    function renderModels() {
      const container = document.getElementById('models-container');
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      const selectedPipeline = document.getElementById('pipelineFilter').value;
      const source = document.getElementById('sourceSelector').value;

      let filtered = models.filter(model => {
        const matchSearch = model.modelId.toLowerCase().includes(searchTerm);
        const matchPipeline = selectedPipeline ? model.pipeline_tag === selectedPipeline : true;
        return matchSearch && matchPipeline;
      });

      if (currentSortByScore) {
        filtered.sort((a, b) => {
          const scoreA = getPrimaryScore(a.benchmark_scores);
          const scoreB = getPrimaryScore(b.benchmark_scores);
          return scoreB - scoreA;
        });
      }

      container.innerHTML = '';
      filtered.forEach(model => {
        const div = document.createElement('div');
        div.className = 'model-card';

        let modelLink = '';
        if (source === 'huggingface') {
          modelLink = `https://huggingface.co/${model.modelId}`;
        } else {
          modelLink = model.link || `https://ollama.com/library/${model.modelId.split(':')[0]}`;
        }

        if (source === 'ollama-available' && !model.parameters) {
          div.innerHTML = `
            <h2><a class="model-link" href="${modelLink}" target="_blank">${model.displayName || model.modelId}</a></h2>
            <div class="meta">Model ID: ${model.modelId}</div>
          `;
        } else {
          div.innerHTML = `
            <h2><a class="model-link" href="${modelLink}" target="_blank">${model.modelId}</a></h2>
            <div class="meta">Likes: ${model.likes || 0} | Downloads: ${model.downloads || 0}</div>
            <div><strong>Pipeline:</strong> ${model.pipeline_tag || 'N/A'}</div>
            <div><strong>Library:</strong> ${model.library_name || 'N/A'}</div>
            <div><strong>Tags:</strong> ${(model.tags || []).join(', ')}</div>
            <div><strong>Parameters:</strong> <pre>${JSON.stringify(model.parameters || {}, null, 2)}</pre></div>
            <div><strong>Benchmarks:</strong> <pre>${JSON.stringify(model.benchmark_scores || {}, null, 2)}</pre></div>
          `;
        }

        container.appendChild(div);
      });
    }

    function getPrimaryScore(scores) {
      if (!scores || typeof scores !== 'object') return 0;
      const values = Object.values(scores).filter(val => typeof val === 'number');
      return values.length ? values[0] : 0;
    }

    document.getElementById('searchBox').addEventListener('input', () => {
      currentSortByScore = false;
      renderModels();
    });

    document.getElementById('pipelineFilter').addEventListener('change', () => {
      currentSortByScore = false;
      renderModels();
    });

    document.getElementById('sourceSelector').addEventListener('change', (e) => {
      currentSortByScore = false;
      loadModels(e.target.value);
    });

    loadModels();
  </script>
</body>
</html>
